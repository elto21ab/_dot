"use strict";var M=Object.create;var u=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var H=(e,t)=>{for(var o in t)u(e,o,{get:t[o],enumerable:!0})},w=(e,t,o,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of X(t))!q.call(e,n)&&n!==o&&u(e,n,{get:()=>t[n],enumerable:!(r=W(t,n))||r.enumerable});return e};var y=(e,t,o)=>(o=e!=null?M(j(e)):{},w(t||!e||!e.__esModule?u(o,"default",{value:e,enumerable:!0}):o,e)),V=e=>w(u({},"__esModule",{value:!0}),e);var J={};H(J,{default:()=>N});module.exports=V(J);var s=require("@raycast/api");var i=require("@raycast/api"),k=y(require("path")),C=y(require("child_process")),b=C.default.spawn,_=()=>new Promise((e,t)=>{let o=b(`${T}`,["--version"]);o.stderr.on("data",$(t));let r=[];o.stdout.on("data",n=>{r.push(n)}),o.stdout.on("end",()=>{let n=parseFloat(r.join("").toString().split(".").slice(0,2).join("."));console.log("current keepassxc version:",n),e(n)})}),m=(0,i.getPreferenceValues)(),h=m.database,z=m.dbPassword,P=m.keyFile,T=k.default.join(m.keepassxcRootPath.path,"Contents/MacOS/keepassxc-cli"),G=async()=>await _()>=2.7?"search":"locate",E=P!=""&&P!=null?["-k",`${P}`]:[],f=[...E,"-q"],O=e=>e.split(`
`).map(t=>t.trim()).filter(t=>t!==void 0&&!t.startsWith("/\u56DE\u6536\u7AD9")&&!t.startsWith("/Trash")&&!t.startsWith("/Deprecated")&&t.length>0).sort(),p=async e=>new Promise((t,o)=>{let r=b(`${T}`,e);r.stdin.write(`${z}
`),r.stdin.end(),r.on("error",o),r.stderr.on("data",$(o));let n=[];r.stdout.on("data",l=>{n.push(l)}),r.stdout.on("end",()=>{let l=n.join("").toString();t(l.slice(0,l.length-1))})}),S=async()=>i.LocalStorage.getItem("entries").then(e=>e==null?[]:O(e.toString())),U=async()=>G().then(e=>{let t=e==="search"?"":"/";return p([e,...E,"-q",`${h}`,t])}).then(e=>(i.LocalStorage.setItem("entries",e),O(e))),$=e=>t=>{t.toString().indexOf("Enter password to unlock")!=-1||t.toString().indexOf("Maximum depth of replacement has been reached")!=-1||t.toString().trim().length==0||e(new Error(t.toString()))},x=e=>p(["show",...f,"-a","Password",`${h}`,`${e}`]),L=e=>p(["show",...f,"-a","Username",`${h}`,`${e}`]),A=async e=>(console.log("paste password of entry:",e),x(e).then(t=>i.Clipboard.paste(t).then(()=>t))),F=async e=>x(e).then(t=>((0,i.showHUD)("Password has been Copied to Clipboard"),i.Clipboard.copy(t,{concealed:!0}).then(()=>t))),v=async e=>(console.log("paste username of entry:",e),L(e).then(t=>i.Clipboard.paste(t).then(()=>t))),I=async e=>L(e).then(t=>((0,i.showHUD)("Username has been Copied to Clipboard"),i.Clipboard.copy(t).then(()=>t))),B=async e=>(console.log("paste totp of entry:",e),D(e).then(t=>i.Clipboard.paste(t).then(()=>t))),R=async e=>D(e).then(t=>((0,i.showHUD)("TOTP has been Copied to Clipboard"),i.Clipboard.copy(t,{concealed:!0}).then(()=>t))),D=e=>p(["show",...f,"-t",`${h}`,`${e}`]),K=e=>p(["show",...f,"-a","URL",`${h}`,`${e}`]);var g=require("react"),a=require("react/jsx-runtime"),c=e=>{console.error(e);let t="";e.message.includes("Invalid credentials were provided")?t="Password":e.message.includes("keepassxc-cli: No such file or directory")||e.message.includes("ENOENT")?t="Path of KeepassXC.app":(e.message.includes("Failed to open database file")||e.message.includes("Error while reading the database: Not a KeePass database"))&&(t="Keepass Database File");let o="Error",r=e.message.trim();t!==""&&(o=`Invalid Preference: ${t}`,r="Please Check Extension Preference."),(0,s.showToast)(s.Toast.Style.Failure,o,r)};function N(){let[e,t]=(0,g.useState)(),[o,r]=(0,g.useState)(!0);return(0,g.useEffect)(()=>{S().then(n=>{console.log("loading entries"),t(n)}).catch(c).then(U).then(n=>{console.log("updating entries"),r(!1),t(n)})},[]),(0,a.jsx)(s.List,{isLoading:o,searchBarPlaceholder:"Type to Search in KeepassXC",throttle:!0,children:e?.map((n,l)=>(0,a.jsx)(s.List.Item,{title:n.split("/")[n.split("/").length-1],accessories:n.split("/").length>2?n.split("/").slice(1,n.split("/").length-1).map(d=>({tag:d})):[],keywords:n.split("/").slice(1),actions:(0,a.jsxs)(s.ActionPanel,{children:[(0,a.jsx)(s.Action,{title:"Paste Password",icon:s.Icon.BlankDocument,onAction:()=>{A(n).then(()=>(0,s.closeMainWindow)()).catch(c)}}),(0,a.jsx)(s.Action,{title:"Paste Username",icon:s.Icon.BlankDocument,shortcut:{modifiers:["shift"],key:"enter"},onAction:()=>{v(n).then(()=>(0,s.closeMainWindow)()).catch(c)}}),(0,a.jsx)(s.Action,{title:"Paste TOTP",icon:s.Icon.BlankDocument,shortcut:{modifiers:["opt"],key:"enter"},onAction:()=>{B(n).then(()=>(0,s.closeMainWindow)()).catch(c)}}),(0,a.jsx)(s.Action,{title:"Copy Password",icon:s.Icon.Clipboard,shortcut:{modifiers:["cmd"],key:"g"},onAction:()=>{F(n).then(()=>(0,s.closeMainWindow)()).catch(c)}}),(0,a.jsx)(s.Action,{title:"Copy Username",icon:s.Icon.Clipboard,shortcut:{modifiers:["cmd"],key:"b"},onAction:()=>{I(n).then(()=>(0,s.closeMainWindow)()).catch(c)}}),(0,a.jsx)(s.Action,{title:"Copy TOTP",icon:s.Icon.Clipboard,shortcut:{modifiers:["cmd"],key:"t"},onAction:()=>{R(n).then(()=>(0,s.closeMainWindow)()).catch(c)}}),(0,a.jsx)(s.Action,{title:"Open URL",icon:s.Icon.Link,shortcut:{modifiers:["shift","cmd"],key:"u"},onAction:()=>{K(n).then(d=>{d!=""&&d!=null?(0,s.open)(d):(0,s.showToast)(s.Toast.Style.Failure,"URL Not Set")}).catch(c)}})]})},l))})}
